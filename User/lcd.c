#include "lcd.h"
#include "systick.h"
#include "io.h"

#define delay_ms delayms

//设置显示起始行
#define     LCD_START_LINE   0x40         //起始行地址为，0x40+（0-63）
//页地址设置
#define     LCD_Page         0xb0         //页地址为：0xb0+(0-8)
//列地址设置
#define     LCD_Ad_H  	     0x10		 //列高四位地址：0x10+()
//#define     LCD_Ad_L		 0x00		 //列低四位地址：0x00+()    
//这里本来是0x00,是uc1705的列L首地址，但是，这个屏前4列显示不出，128列一共后移了4列，
//所以现在找成0x04,这样子，在屏上是从第一列开始显示的。
#define     LCD_Ad_L		 0x04		 //列低四位地址：0x00+()    
//显示反转
#define			INVERSE_DISPLAY_NORMAL		0xa6
#define			INVERSE_DISPLAY_INVERSE		0xa7
//行列地址方向设置
//行正向
#define     SEG_Norm()       lcd_wr_cmd8(0xa0)
//行反向
#define     SEG_Reve()       lcd_wr_cmd8(0xa1)
//列正向
#define     Com_Norm()       lcd_wr_cmd8(0xc0)
//列反向
#define     Com_Reve()       lcd_wr_cmd8(0xcf)


unsigned char charTable[][5];



void LCD_CS(char v){
	BitAction bit = v ? Bit_SET : Bit_RESET;
	GPIO_WriteBit(LCD_DATA_PORT, LCD_CS_PIN, bit);
}
void LCD_RS(char v){
	BitAction bit = v ? Bit_SET : Bit_RESET;
	GPIO_WriteBit(LCD_DATA_PORT, LCD_RS_PIN, bit);
}
void LCD_SCLK(char v){
	BitAction bit = v ? Bit_SET : Bit_RESET;
	GPIO_WriteBit(LCD_DATA_PORT, LCD_SCLK_PIN, bit);
}
void LCD_SDIN(char v) {
	BitAction bit = v ? Bit_SET : Bit_RESET;
	GPIO_WriteBit(LCD_DATA_PORT, LCD_SDIN_PIN, bit);
}
void LCD_RST(char v) {
	BitAction bit = v ? Bit_SET : Bit_RESET;
	GPIO_WriteBit(LCD_CONTROL_PORT, LCD_RST_PIN, bit);
}
void LCD_BL(char v) {
	BitAction bit = v ? Bit_SET : Bit_RESET;
	GPIO_WriteBit(LCD_CONTROL_PORT, LCD_BL_PIN, bit);
}

void lcd_wr_cmd8(u8 cmd)
{
	uint8_t i;
  LCD_CS(0);
  LCD_RS(0);
	for (i=0;i<8;i++) 
	{
		LCD_SCLK(0);
		if (cmd & 0x80)
			LCD_SDIN(1);
		else
			LCD_SDIN(0);
		LCD_SCLK(1);
		cmd <<= 1;
	}
  LCD_CS(1);
}

void lcd_wr_data8(u8 cmd)
{
	uint8_t i;
  LCD_CS(0);
  LCD_RS(1);
	for (i=0;i<8;i++) 
	{
		LCD_SCLK(0);
		if (cmd & 0x80)
			LCD_SDIN(1);
		else
			LCD_SDIN(0);
		LCD_SCLK(1);
		cmd <<= 1;
	}
  LCD_CS(1);
}

void lcd_wr_CmdData8(u8 cmd,u8 dat)
{
	lcd_wr_cmd8(cmd);
	lcd_wr_data8(dat);
}


void LCD_Init(void)
{
	RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOC | RCC_AHB1Periph_GPIOB, ENABLE);

	IO_OUT_PULL_UP(LCD_DATA_PORT, LCD_CS_PIN | LCD_RS_PIN | LCD_SCLK_PIN | LCD_SDIN_PIN);
	IO_OUT_PULL_UP(LCD_CONTROL_PORT, LCD_RST_PIN/*|LCD_BL_PIN*/);
	
	
	GPIO_SetBits(LCD_DATA_PORT, LCD_CS_PIN | LCD_RS_PIN | LCD_SCLK_PIN | LCD_SDIN_PIN);
	GPIO_SetBits(LCD_CONTROL_PORT, LCD_RST_PIN/*|LCD_BL_PIN*/);

	
	  LCD_CS(1);
	  LCD_RS(1);
	  LCD_SCLK(1);
	  LCD_SDIN(1);
		LCD_BL(0);
		
	  LCD_RST(0);
		delay_ms(50);
	  LCD_RST(1);
		delay_ms(50);

	
	lcd_wr_cmd8(0xe2);     //软件复位
	delay_ms(5);
	lcd_wr_cmd8(0x2c);     //升压步骤1
	delay_ms(5);
	lcd_wr_cmd8(0x2e);     //升压步骤2
	delay_ms(5);
	lcd_wr_cmd8(0x2f);     //升压步骤3
	delay_ms(5);
	lcd_wr_cmd8(0x24);//24     //粗调对比度，可设置范围0x20~0x27
	lcd_wr_cmd8(0x81);     //微调对比度
	lcd_wr_cmd8(0x25);//20     //微调对比度，可设置范围0x00~0x3f
	lcd_wr_cmd8(0xa2);     //1/9偏压比（bias）
#ifdef LCD_MIRROR_X
	lcd_wr_cmd8(0xa1);     //????? ????
#else
	lcd_wr_cmd8(0xa0);     //????? ????
#endif
#ifdef LCD_MIRROR_Y
	lcd_wr_cmd8(0xcf);     //????? ????
#else
	lcd_wr_cmd8(0xc0);     //????? ????
#endif
	lcd_wr_cmd8(0x40);     //起始行，从第一行开始
	lcd_wr_cmd8(0xaf);     //开显示

}

void LCD_On()
{
	lcd_wr_cmd8(0xaf);
}

void LCD_Off()
{
	lcd_wr_cmd8(0xae);
}
/*************************************
**函数名称：LCD_Fill()
**功    能：LCD全屏显示数据程序
**输    入：8位数据
**输    出：无
************************************/
void LCD_Fill(u8 dat)
{
   u8 page;
   u8 colume;
   for(page=0;page<4;page++)
   { 
			lcd_wr_cmd8(LCD_Page+page);
			lcd_wr_cmd8(LCD_Ad_H);
			lcd_wr_cmd8(LCD_Ad_L);
			for(colume=0;colume<LCD_X_end;colume++)
				lcd_wr_data8(dat);
	 } 
}

/*************************************
**函数名称：LCD_Clear()
**功    能：LCD清屏程序（全屏填充0x00）
**输    入：8位数据
**输    出：无
************************************/
void LCD_Clear()
{
	LCD_Fill(0x00);  
//	LCD_Fill(0xaa);  
}

void LCD_inverse(u8 On)
{
	if(On)
		lcd_wr_cmd8(INVERSE_DISPLAY_INVERSE);	
	else
		lcd_wr_cmd8(INVERSE_DISPLAY_NORMAL);	
}


void LCD_set_XY(u8 row,u8 colume)
{
	unsigned char col_high;
	unsigned char col_low ;
	if(row >3)
		return;
	if(colume > 128)
		return;
	col_high=colume>>4;
	col_low =colume&0x0f;
	
#ifdef LCD_MIRROR_Y
	row = 3-row;
#endif
	lcd_wr_cmd8(LCD_Page+row);
	lcd_wr_cmd8(LCD_Ad_H+col_high);
	lcd_wr_cmd8(LCD_Ad_L+col_low);
}

void LCD_draw_tx()
{
	u8 i,j=0;
	for(i=0;i<8;i++)
	{
		j = j*2 + 1;
		lcd_wr_data8(j);
	}
}

void LCD_char(char C)
{
	u8 i = C;	
	unsigned char *c = charTable[i];
	
	for(i=0;i<5;i++)
		lcd_wr_data8(c[i]);
	lcd_wr_data8(0x00);
}

void LCD_show_string(char *C)
{
	while(*C)
		LCD_char(*C++);
}


/*********************************************************************
 **函数名称：LCD_Word()
 **功    能：输入单个汉字（16x16符号）
 **输    入：页地址，列地址、字符数组
 **输    出：无
 ***********************************************************************/
void LCD_show_hanzi(u8 row,u8 colume,u8 *pword)
{
	unsigned char i;
	
	if(row > 3)
		return;
		
	LCD_set_XY(row,colume);
	for(i=0;i<16;i++)
		lcd_wr_data8(*(pword+i));
	
#ifdef LCD_MIRROR_Y
	LCD_set_XY(row+1,colume);
#else
	LCD_set_XY(row-1,colume);
#endif
	for(i=0;i<16;i++)
	{
		lcd_wr_data8(*(pword+16+i));
	}
}


unsigned char charTable[][5] = 
{/* 0x00 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x01 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x02 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x03 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x04 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x05 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x06 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x07 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x08 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x09 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x0A */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x0B */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x0C */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x0D */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x0E */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x0F */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x10 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x11 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x12 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x13 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x14 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x15 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x16 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x17 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x18 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x19 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x1A */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x1B */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x1C */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x1D */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x1E */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x1F */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x20 */
{0x00, 0x00, 0x00, 0x00, 0x00},
/* 0x21 */
{0x00, 0x7b, 0x7b, 0x00, 0x00},
/* 0x22 */
{0xe0, 0x00, 0xe0, 0x00, 0x00},
/* 0x23 */
{0x14, 0x7f, 0x14, 0x7f, 0x28},
/* 0x24 */
{0x3a, 0x2b, 0x6a, 0x2e, 0x00},
/* 0x25 */
{0x83, 0x0c, 0x30, 0xc1, 0x00},
/* 0x26 */
{0x66, 0x99, 0x95, 0x66, 0x1a},
/* 0x27 */
{0x00, 0x00, 0xe0, 0x00, 0x00},
/* 0x28 */
{0x1c, 0x22, 0x41, 0x00, 0x00},
/* 0x29 */
{0x00, 0x41, 0x22, 0x1c, 0x00},
/* 0x2A */
{0x00, 0xa0, 0x40, 0xa0, 0x00},
/* 0x2B */
{0x08, 0x08, 0x3e, 0x08, 0x10},
/* 0x2C */
{0x00, 0x0d, 0x0e, 0x00, 0x00},
/* 0x2D */
{0x10, 0x10, 0x10, 0x10, 0x00},
/* 0x2E */
{0x00, 0x03, 0x03, 0x00, 0x00},
/* 0x2F */
{0x03, 0x0c, 0x30, 0xc0, 0x00},
/* 0x30 */
{0x7f, 0x45, 0x49, 0x7f, 0x00},
/* 0x31 */
{0x00, 0x21, 0x7f, 0x01, 0x00},
/* 0x32 */
{0x4f, 0x49, 0x49, 0x79, 0x00},
/* 0x33 */
{0x49, 0x49, 0x49, 0x7f, 0x00},
/* 0x34 */
{0x78, 0x08, 0x08, 0x7f, 0x00},
/* 0x35 */
{0x79, 0x49, 0x49, 0x4f, 0x00},
/* 0x36 */
{0x7f, 0x49, 0x49, 0x4f, 0x00},
/* 0x37 */
{0x40, 0x40, 0x40, 0x7f, 0x00},
/* 0x38 */
{0x7f, 0x49, 0x49, 0x7f, 0x00},
/* 0x39 */
{0x79, 0x49, 0x49, 0x7f, 0x00},
/* 0x3A */
{0x00, 0x1b, 0x1b, 0x00, 0x00},
/* 0x3B */
{0x00, 0x19, 0x1b, 0x00, 0x00},
/* 0x3C */
{0x08, 0x14, 0x22, 0x41, 0x00},
/* 0x3D */
{0x24, 0x24, 0x24, 0x24, 0x00},
/* 0x3E */
{0x41, 0x22, 0x14, 0x08, 0x00},
/* 0x3F */
{0x40, 0x8b, 0x8b, 0x70, 0x00},
/* 0x40 */
{0x7e, 0x81, 0x99, 0x72, 0x00},
/* 0x41 */
{0x7f, 0x88, 0x88, 0x7f, 0x00},
/* 0x42 */
{0xff, 0x89, 0x89, 0x76, 0x00},
/* 0x43 */
{0x7e, 0x81, 0x81, 0x42, 0x00},
/* 0x44 */
{0xff, 0x81, 0xc3, 0x3c, 0x00},
/* 0x45 */
{0xff, 0x89, 0x89, 0x89, 0x00},
/* 0x46 */
{0xff, 0x90, 0x90, 0x90, 0x00},
/* 0x47 */
{0x7e, 0x81, 0x89, 0x4f, 0x00},
/* 0x48 */
{0xff, 0x08, 0x08, 0xff, 0x00},
/* 0x49 */
{0x81, 0xff, 0x81, 0x00, 0x00},
/* 0x4A */
{0x82, 0x81, 0xfe, 0x80, 0x00},
/* 0x4B */
{0xff, 0x18, 0x24, 0xc3, 0x00},
/* 0x4C */
{0xff, 0x01, 0x01, 0x01, 0x00},
/* 0x4D */
{0xff, 0xc0, 0x70, 0xc0, 0xfe},
/* 0x4E */
{0xff, 0x70, 0x0e, 0xff, 0x00},
/* 0x4F */
{0x7e, 0x81, 0x81, 0x7e, 0x00},
/* 0x50 */
{0xff, 0x90, 0x90, 0x60, 0x00},
/* 0x51 */
{0x7e, 0x83, 0x87, 0x7d, 0x00},
/* 0x52 */
{0x7f, 0x88, 0x8c, 0x73, 0x00},
/* 0x53 */
{0x62, 0x91, 0x89, 0x46, 0x00},
/* 0x54 */
{0x80, 0x80, 0xff, 0x80, 0x00},
/* 0x55 */
{0xfe, 0x01, 0x01, 0xfe, 0x00},
/* 0x56 */
{0xff, 0x02, 0x04, 0xf8, 0x00},
/* 0x57 */
{0xff, 0x03, 0x0c, 0x03, 0xfe},
/* 0x58 */
{0xe7, 0x18, 0x18, 0xe7, 0x00},
/* 0x59 */
{0xc0, 0x30, 0x1f, 0x30, 0x80},
/* 0x5A */
{0x83, 0x8d, 0x99, 0xe1, 0x00},
/* 0x5B */
{0xff, 0x81, 0x81, 0x00, 0x00},
/* 0x5C */
{0xc0, 0x30, 0x0c, 0x03, 0x00},
/* 0x5D */
{0x00, 0x81, 0x81, 0xff, 0x00},
/* 0x5E */
{0x30, 0xc0, 0x30, 0x00, 0x00},
/* 0x5F */
{0x01, 0x01, 0x01, 0x01, 0x00},
/* 0x60 */
{0x00, 0xc0, 0xe0, 0xc0, 0x00},
/* 0x61 */
{0x06, 0x29, 0x2a, 0x1f, 0x00},
/* 0x62 */
{0x3f, 0x09, 0x09, 0x06, 0x00},
/* 0x63 */
{0x0e, 0x11, 0x11, 0x11, 0x00},
/* 0x64 */
{0x06, 0x09, 0x09, 0x7f, 0x00},
/* 0x65 */
{0x0e, 0x15, 0x15, 0x0d, 0x00},
/* 0x66 */
{0x08, 0x3f, 0x48, 0x28, 0x00},
/* 0x67 */
{0x18, 0x25, 0x25, 0x3e, 0x00},
/* 0x68 */
{0x7f, 0x08, 0x08, 0x07, 0x00},
/* 0x69 */
{0x09, 0x2f, 0x01, 0x00, 0x00},
/* 0x6A */
{0x01, 0x09, 0x2f, 0x00, 0x00},
/* 0x6B */
{0x3f, 0x04, 0x0a, 0x11, 0x00},
/* 0x6C */
{0x00, 0x3f, 0x01, 0x02, 0x00},
/* 0x6D */
{0x0f, 0x10, 0x1f, 0x10, 0x1e},
/* 0x6E */
{0x1f, 0x10, 0x10, 0x0f, 0x00},
/* 0x6F */
{0x0e, 0x11, 0x11, 0x0e, 0x00},
/* 0x70 */
{0x3f, 0x24, 0x24, 0x18, 0x00},
/* 0x71 */
{0x18, 0x24, 0x24, 0x3f, 0x00},
/* 0x72 */
{0x10, 0x1f, 0x04, 0x18, 0x00},
/* 0x73 */
{0x09, 0x15, 0x15, 0x12, 0x00},
/* 0x74 */
{0x08, 0x3f, 0x09, 0x0a, 0x00},
/* 0x75 */
{0x1e, 0x01, 0x01, 0x1e, 0x00},
/* 0x76 */
{0x1f, 0x02, 0x06, 0x1c, 0x00},
/* 0x77 */
{0x0f, 0x01, 0x06, 0x01, 0x1e},
/* 0x78 */
{0x1b, 0x04, 0x04, 0x1b, 0x00},
/* 0x79 */
{0x18, 0x05, 0x05, 0x1f, 0x00},
/* 0x7A */
{0x13, 0x15, 0x15, 0x19, 0x00},
/* 0x7B */
{0x08, 0x3e, 0x41, 0x41, 0x00},
/* 0x7C */
{0x00, 0x00, 0x7f, 0x00, 0x00},
/* 0x7D */
{0x41, 0x41, 0x3e, 0x08, 0x00},
/* 0x7E */
{0x08, 0x10, 0x08, 0x04, 0x10},
/* 0x7F */
{0x00, 0x00, 0x00, 0x00, 0x00} 
};


